<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stratagem â€” Spectator View</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: #0a0a1a; color: #e0e0e0; display: flex; height: 100vh; overflow: hidden; }

/* Sidebar */
#sidebar { width: 340px; background: #10102a; border-right: 1px solid #2a2a4a; display: flex; flex-direction: column; }
#header { padding: 14px 16px; background: #0d0d22; border-bottom: 1px solid #2a2a4a; text-align: center; }
#header h1 { font-size: 22px; color: #8af; letter-spacing: 3px; }
#header .sub { font-size: 11px; color: #556; margin-top: 2px; }

/* Setup */
#setup { display: flex; gap: 6px; padding: 10px 14px; border-bottom: 1px solid #1a1a3a; flex-wrap: wrap; }
#setup input { flex: 1; background: #1a1a3a; border: 1px solid #3a3a5a; color: #e0e0e0; padding: 5px 8px; border-radius: 4px; font-size: 12px; min-width: 120px; }
#setup button { background: #2a5a2a; border: 1px solid #3a7a3a; color: #e0e0e0; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; }
#setup button:hover { background: #3a7a3a; }
#setup .or { color: #556; font-size: 11px; align-self: center; }
#load-replay-btn { background: #4a3a6a; border-color: #6a5a8a; }
#load-replay-btn:hover { background: #5a4a7a; }
#mode-indicator { width: 100%; font-size: 10px; text-align: center; padding: 4px 0; color: #8af; }

/* Sections */
.section-head { padding: 8px 14px; font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: #8af; background: #0e0e25; border-bottom: 1px solid #1a1a3a; cursor: pointer; user-select: none; }
.section-head:hover { background: #12123a; }

/* Player cards */
#players { overflow-y: auto; max-height: 280px; }
.pcard { padding: 8px 14px; border-bottom: 1px solid #151535; transition: background 0.2s; }
.pcard:hover { background: #161640; }
.pcard.dead { opacity: 0.35; }
.pname { font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px; }
.pdot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.pciv { font-size: 11px; color: #888; margin-left: auto; }
.pstats { display: flex; gap: 10px; font-size: 11px; color: #999; margin-top: 3px; flex-wrap: wrap; }
.pstats .age { color: #fc6; font-weight: 600; }
.pstats .tech { color: #6cf; }
.ptreaties { font-size: 10px; color: #6a8; margin-top: 2px; }
.ptrust-penalty { color: #f66; font-size: 10px; }

/* Event log */
#event-log { flex: 1; overflow-y: auto; padding: 6px 14px; font-size: 11px; min-height: 60px; }
.evt { padding: 3px 0; border-bottom: 1px solid #111130; line-height: 1.4; }
.evt-turn { color: #8af; font-weight: 600; margin-right: 6px; }

/* Diplo panel */
#diplo-section { max-height: 250px; overflow-y: auto; border-top: 1px solid #1a1a3a; display: flex; flex-direction: column; }
.diplo-tabs { display: flex; border-bottom: 1px solid #1a1a3a; }
.diplo-tab { flex: 1; text-align: center; padding: 6px; font-size: 11px; cursor: pointer; color: #888; border-bottom: 2px solid transparent; }
.diplo-tab.active { color: #8af; border-bottom-color: #8af; }
.diplo-tab:hover { color: #aaf; }
#diplo-content { flex: 1; overflow-y: auto; padding: 6px 14px; font-size: 11px; }
.dmsg { padding: 4px 6px; margin-bottom: 4px; background: #141438; border-radius: 4px; }
.dmsg.private { background: #281428; border-left: 2px solid #a66; }
.dmsg.public { border-left: 2px solid #6a6; }
.dfrom { font-weight: 600; }
.dprivate-label { color: #f88; font-size: 9px; margin-left: 4px; }
.treaty-item { padding: 4px 6px; margin-bottom: 3px; background: #142814; border-radius: 4px; border-left: 2px solid #6a6; }
.treaty-broken { background: #281414; border-left-color: #a44; text-decoration: line-through; opacity: 0.6; }

/* Main */
#main { flex: 1; display: flex; flex-direction: column; }
#map-container { flex: 1; position: relative; overflow: hidden; background: #080818; }
canvas { width: 100%; height: 100%; }

/* Controls */
#controls { height: 44px; background: #10102a; border-top: 1px solid #2a2a4a; display: flex; align-items: center; padding: 0 14px; gap: 8px; }
#controls button { background: #2a2a5a; color: #e0e0e0; border: 1px solid #3a3a6a; padding: 4px 14px; cursor: pointer; border-radius: 4px; font-size: 13px; }
#controls button:hover { background: #3a3a7a; }
#turn-display { font-size: 16px; font-weight: 700; color: #8af; min-width: 90px; }
#turn-slider { flex: 1; }
#speed-display { font-size: 11px; color: #888; min-width: 50px; text-align: right; }

/* Winner */
.winner-banner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.92); padding: 24px 50px; border: 2px solid gold; border-radius: 12px; font-size: 28px; color: gold; text-align: center; z-index: 100; display: none; }
.winner-banner .sub { font-size: 14px; color: #ccc; margin-top: 8px; }

/* Tooltip */
#tooltip { position: absolute; background: rgba(10,10,30,0.95); border: 1px solid #4a4a7a; border-radius: 6px; padding: 8px 12px; font-size: 11px; pointer-events: none; display: none; z-index: 50; max-width: 240px; line-height: 1.5; }

/* Drop zone */
#drop-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(40,40,100,0.7); display: none; z-index: 200; justify-content: center; align-items: center; font-size: 24px; color: #8af; }

/* Hidden file input */
#file-input { display: none; }
</style>
</head>
<body>
<div id="drop-overlay">ğŸ“‚ Drop replay JSON file here</div>
<input type="file" id="file-input" accept=".json">

<div id="sidebar">
  <div id="header">
    <h1>âš”ï¸ STRATAGEM</h1>
    <div class="sub">AI Agent Strategy Game v2</div>
  </div>
  <div id="setup">
    <input id="server-url" placeholder="Server URL" value="http://localhost:8000">
    <button onclick="connectServer()">Connect</button>
    <span class="or">or</span>
    <button id="load-replay-btn" onclick="document.getElementById('file-input').click()">ğŸ“‚ Load Replay</button>
    <div id="mode-indicator"></div>
  </div>
  <div class="section-head" onclick="toggleSection('players')">Players</div>
  <div id="players"></div>
  <div class="section-head" onclick="toggleSection('event-log')">Events</div>
  <div id="event-log"></div>
  <div class="section-head">Diplomacy</div>
  <div id="diplo-section">
    <div class="diplo-tabs">
      <div class="diplo-tab active" data-tab="all" onclick="switchDiploTab('all')">All</div>
      <div class="diplo-tab" data-tab="public" onclick="switchDiploTab('public')">Public</div>
      <div class="diplo-tab" data-tab="private" onclick="switchDiploTab('private')">Private</div>
      <div class="diplo-tab" data-tab="treaties" onclick="switchDiploTab('treaties')">Treaties</div>
    </div>
    <div id="diplo-content"></div>
  </div>
</div>
<div id="main">
  <div id="map-container">
    <canvas id="map"></canvas>
    <div id="tooltip"></div>
    <div class="winner-banner" id="winner-banner"></div>
  </div>
  <div id="controls">
    <span id="turn-display">Turn 0</span>
    <button onclick="prevTurn()">â—€</button>
    <button onclick="togglePlay()" id="play-btn">â–¶ Play</button>
    <button onclick="nextTurn()">â–¶</button>
    <button onclick="goToStart()">â®</button>
    <button onclick="goToEnd()">â­</button>
    <input type="range" id="turn-slider" min="0" max="0" value="0" oninput="goToTurn(+this.value)">
    <span id="speed-display">1x</span>
  </div>
</div>

<script>
// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLORS = ['#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6','#1abc9c','#e67e22','#ecf0f1'];
const TERRAIN_COLORS = { P:'#4a7a3a', F:'#2d5a1e', M:'#6a6a7a', C:'#2a5a8a', R:'#3a7a9a' };
const TERRAIN_NAMES = { P:'Plains', F:'Forest', M:'Mountain', C:'Coast', R:'River' };
const UNIT_EMOJI = ['ğŸ—¡','âš”ï¸','ğŸ¹','ğŸ´','ğŸ’£','ğŸ›¡','ğŸ‘','ğŸª“','ğŸŒ¿','ğŸ´â€â˜ ï¸','ğŸ“–'];
const UNIT_NAMES = ['Militia','Infantry','Archers','Cavalry','Siege','Knights','Scout','Huscarl','Herbalist','Corsair','Sage'];
const BLDG_NAMES = { F:'Farm', M:'Mine', K:'Market', B:'Barracks', X:'Fortress', T:'Trade Post', W:'Watchtower' };
const BLDG_EMOJI = { F:'ğŸŒ¾', M:'â›ï¸', K:'ğŸ’°', B:'ğŸ‹ï¸', X:'ğŸ°', T:'ğŸ“¦', W:'ğŸ”­' };
const CIV_EMOJI = { ironborn:'âš’ï¸', verdanti:'ğŸŒ¿', tidecallers:'ğŸŒŠ', ashwalkers:'ğŸ”¥' };
const AGE_NAMES = { 1:'Bronze', 2:'Iron', 3:'Steel' };

let replay = null;
let turnIdx = 0;
let playing = false;
let playTimer = null;
let playSpeed = 1000;  // ms per turn
let canvas, ctx;
let battleFlash = {};
let viewMode = 'replay';  // 'replay' or 'live'
let diploTab = 'all';
let liveInterval = null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
  canvas = document.getElementById('map');
  ctx = canvas.getContext('2d');
  resize();
  window.addEventListener('resize', resize);
  canvas.addEventListener('mousemove', onMouse);
  canvas.addEventListener('mouseleave', () => { document.getElementById('tooltip').style.display = 'none'; });

  // File input handler
  document.getElementById('file-input').addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) loadReplayFile(file);
  });

  // Drag and drop
  document.addEventListener('dragover', e => { e.preventDefault(); document.getElementById('drop-overlay').style.display = 'flex'; });
  document.getElementById('drop-overlay').addEventListener('dragleave', () => { document.getElementById('drop-overlay').style.display = 'none'; });
  document.addEventListener('drop', e => {
    e.preventDefault();
    document.getElementById('drop-overlay').style.display = 'none';
    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.json')) loadReplayFile(file);
  });

  // Speed control with keyboard
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowRight') nextTurn();
    else if (e.key === 'ArrowLeft') prevTurn();
    else if (e.key === ' ') { e.preventDefault(); togglePlay(); }
    else if (e.key === '+' || e.key === '=') { playSpeed = Math.max(200, playSpeed - 200); updateSpeed(); }
    else if (e.key === '-') { playSpeed = Math.min(3000, playSpeed + 200); updateSpeed(); }
  });

  const params = new URLSearchParams(location.search);
  if (params.get('server')) { document.getElementById('server-url').value = params.get('server'); connectServer(); }
});

function resize() {
  const r = canvas.parentElement.getBoundingClientRect();
  canvas.width = r.width * devicePixelRatio;
  canvas.height = r.height * devicePixelRatio;
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  if (replay) render();
}

function updateSpeed() {
  document.getElementById('speed-display').textContent = (1000/playSpeed).toFixed(1) + 'x';
  if (playing) { clearInterval(playTimer); playTimer = setInterval(autoAdvance, playSpeed); }
}

// â”€â”€ Data Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadReplayFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      viewMode = 'replay';
      load(data);
      document.getElementById('mode-indicator').textContent = `ğŸ“¼ Replay: ${file.name}`;
    } catch(err) { alert('Invalid JSON: ' + err); }
  };
  reader.readAsText(file);
}

function connectServer() {
  const url = document.getElementById('server-url').value.trim();
  if (url.endsWith('.json')) {
    fetch(url).then(r=>r.json()).then(data => { viewMode = 'replay'; load(data); }).catch(e=>alert('Error: '+e));
    return;
  }
  viewMode = 'live';
  document.getElementById('mode-indicator').textContent = 'ğŸ”´ Live â€” connecting...';
  fetch(url+'/games').then(r=>r.json()).then(games => {
    if (!games.length) { alert('No games running'); return; }
    const gid = games[games.length-1].game_id;
    fetchLiveState(url, gid);
    // Poll for updates
    if (liveInterval) clearInterval(liveInterval);
    liveInterval = setInterval(() => fetchLiveState(url, gid), 2000);
  }).catch(e=>alert(e));
}

function fetchLiveState(url, gid) {
  fetch(url+'/games/'+gid+'/spectator?mode=live').then(r=>r.json()).then(data => {
    const replayData = {
      game_id: data.game_id,
      players: Object.keys(data.players),
      winner: data.winner,
      turns: data.turn_log || [],
      diplomacy: data.diplo_log || [],
      treaties: data.treaties || [],
    };
    const wasAtEnd = !replay || turnIdx >= (replay.turns.length - 1);
    load(replayData);
    if (wasAtEnd) { turnIdx = Math.max(0, replay.turns.length - 1); onTurnChange(); }
    document.getElementById('mode-indicator').textContent = `ğŸ”´ Live: ${gid} (Turn ${data.turn})`;
    if (data.winner) {
      clearInterval(liveInterval);
      document.getElementById('mode-indicator').textContent = `âœ… Finished: ${gid}`;
    }
  }).catch(() => {});
}

function load(data) {
  replay = data;
  if (!replay.turns || !replay.turns.length) {
    alert('No turn data in replay');
    return;
  }
  turnIdx = 0;
  document.getElementById('turn-slider').max = Math.max(0, data.turns.length - 1);
  render();
}

function toggleSection(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === 'none' ? '' : 'none';
}

// â”€â”€ Playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function prevTurn() { if (turnIdx > 0) { turnIdx--; onTurnChange(); } }
function nextTurn() { if (replay && turnIdx < replay.turns.length-1) { turnIdx++; onTurnChange(); } }
function goToTurn(i) { turnIdx = i; onTurnChange(); }
function goToStart() { turnIdx = 0; onTurnChange(); }
function goToEnd() { if (replay) { turnIdx = replay.turns.length-1; onTurnChange(); } }
function autoAdvance() {
  if (replay && turnIdx < replay.turns.length-1) { turnIdx++; onTurnChange(); }
  else togglePlay();
}
function togglePlay() {
  playing = !playing;
  document.getElementById('play-btn').textContent = playing ? 'â¸' : 'â–¶ Play';
  if (playing) playTimer = setInterval(autoAdvance, playSpeed);
  else clearInterval(playTimer);
}

function onTurnChange() {
  const t = replay.turns[turnIdx];
  if (t && t.combats) {
    t.combats.forEach(c => { battleFlash[c.p] = 20; });
  }
  render();
}

// â”€â”€ Diplomacy Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchDiploTab(tab) {
  diploTab = tab;
  document.querySelectorAll('.diplo-tab').forEach(el => el.classList.toggle('active', el.dataset.tab === tab));
  if (replay) render();
}

// â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  if (!replay) return;
  const t = replay.turns[turnIdx];
  if (!t) return;
  const state = t.state;
  const playerIds = replay.players || Object.keys(state.players);

  document.getElementById('turn-display').textContent = `Turn ${t.turn}`;
  document.getElementById('turn-slider').value = turnIdx;

  renderPlayers(state, playerIds);
  renderEvents(t, playerIds);
  renderDiplo(t, playerIds);
  renderMap(state, playerIds, t);
  renderWinner(t, playerIds);
}

function renderPlayers(state, playerIds) {
  const el = document.getElementById('players');
  const treaties = state.treaties || replay.treaties || [];
  const trust = state.trust || {};

  el.innerHTML = playerIds.map((pid, i) => {
    const p = state.players[pid];
    if (!p) return '';
    const civ = p.civ || '?';
    const age = AGE_NAMES[p.age] || '?';
    const techs = (p.techs||[]).join(', ') || 'none';

    // Active treaties for this player
    const playerTreaties = treaties.filter(t => t.parties && t.parties.includes(pid) && !t.broken_by);
    const treatyStr = playerTreaties.map(t => {
      const other = t.parties.find(p2 => p2 !== pid);
      return `${t.type} w/ ${other}`;
    }).join(', ');

    const penalty = trust[pid] || 0;

    return `<div class="pcard${p.alive?'':' dead'}">
      <div class="pname"><span class="pdot" style="background:${COLORS[i]}"></span>
        ${pid} ${p.alive?'':'ğŸ’€'}
        <span class="pciv">${CIV_EMOJI[civ]||''} ${civ}</span></div>
      <div class="pstats">
        <span class="age">${age} Age</span>
        <span>ğŸ°${p.provinces||0}</span> <span>âš”ï¸${p.units||0}</span>
        <span>ğŸ–${p.resources[0]}</span> <span>â›ï¸${p.resources[1]}</span> <span>ğŸ’°${p.resources[2]}</span>
        ${p.income ? `<span style="color:#5a5">(+${p.income[0]}/+${p.income[1]}/+${p.income[2]})</span>` : ''}
        <span class="tech">ğŸ“œ${techs}</span>
      </div>
      ${treatyStr ? `<div class="ptreaties">ğŸ¤ ${treatyStr}</div>` : ''}
      ${penalty > 0 ? `<div class="ptrust-penalty">âš ï¸ Broken ${penalty} treaty(s)</div>` : ''}
    </div>`;
  }).join('');
}

function renderEvents(t, playerIds) {
  const el = document.getElementById('event-log');
  let evts = [];
  const start = Math.max(0, turnIdx - 3);
  for (let i = start; i <= turnIdx; i++) {
    const tt = replay.turns[i];
    if (tt && tt.events) {
      tt.events.forEach(e => evts.push({ turn: tt.turn, text: e }));
    }
  }
  el.innerHTML = evts.slice(-30).map(e =>
    `<div class="evt"><span class="evt-turn">T${e.turn}</span>${e.text}</div>`
  ).join('');
  el.scrollTop = el.scrollHeight;
}

function renderDiplo(t, playerIds) {
  const el = document.getElementById('diplo-content');
  const isReplay = viewMode === 'replay';
  const allMsgs = replay.diplomacy || [];
  const msgsUpToTurn = allMsgs.filter(m => m.turn <= t.turn);

  if (diploTab === 'treaties') {
    const treaties = (replay.turns[turnIdx]?.state?.treaties) || replay.treaties || [];
    el.innerHTML = treaties.map(tr => {
      const broken = tr.broken_by;
      return `<div class="treaty-item ${broken ? 'treaty-broken' : ''}">
        ${tr.type}: ${tr.parties.join(' & ')} (T${tr.since})${broken ? ` â€” broken by ${broken}` : ''}
      </div>`;
    }).join('') || '<div style="padding:8px;color:#666">No treaties yet</div>';
    return;
  }

  let filtered = msgsUpToTurn;
  if (diploTab === 'public') filtered = filtered.filter(m => m.public);
  else if (diploTab === 'private') filtered = filtered.filter(m => !m.public);

  // In live mode, hide private messages
  if (!isReplay && viewMode === 'live') {
    filtered = filtered.filter(m => m.public);
  }

  el.innerHTML = filtered.slice(-25).map(m => {
    const ci = playerIds.indexOf(m.from);
    const isPrivate = !m.public;
    const privateLabel = isPrivate ? `<span class="dprivate-label">[PRIVATE to ${m.to}]</span>` : '';
    return `<div class="dmsg ${isPrivate ? 'private' : 'public'}">
      <span style="color:#888;font-size:9px">T${m.turn}</span>
      <span class="dfrom" style="color:${COLORS[ci]}">${m.from}</span>${privateLabel}: ${m.content}
    </div>`;
  }).join('') || '<div style="padding:8px;color:#666">No messages yet</div>';
  el.scrollTop = el.scrollHeight;
}

function renderWinner(t, playerIds) {
  const b = document.getElementById('winner-banner');
  if (t.winner) {
    b.style.display = 'block';
    const ci = playerIds.indexOf(t.winner);
    const p = t.state.players[t.winner];
    b.innerHTML = `ğŸ† ${t.winner} WINS!<div class="sub">${CIV_EMOJI[p?.civ]||''} ${p?.civ||''} â€” Turn ${t.turn}</div>`;
    b.style.borderColor = COLORS[ci] || 'gold';
  } else b.style.display = 'none';
}

function renderMap(state, playerIds, turnData) {
  const W = canvas.width / devicePixelRatio;
  const H = canvas.height / devicePixelRatio;
  ctx.clearRect(0, 0, W, H);

  const provs = Object.entries(state.provinces);
  const pad = 40;
  const sx = (x) => pad + (x / 1000) * (W - pad*2);
  const sy = (y) => pad + (y / 1000) * (H - pad*2);

  // Draw adjacency edges
  ctx.strokeStyle = '#1a1a3a';
  ctx.lineWidth = 1.5;
  const drawn = new Set();
  provs.forEach(([pid, prov]) => {
    const x1 = sx(prov.x), y1 = sy(prov.y);
    (prov.adjacent || []).forEach(adj => {
      const key = [pid, adj].sort().join('-');
      if (drawn.has(key)) return;
      drawn.add(key);
      const ap = state.provinces[adj];
      if (!ap) return;
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(sx(ap.x), sy(ap.y));
      ctx.stroke();
    });
  });

  // Draw trade routes
  if (state.trade_routes) {
    ctx.setLineDash([6, 4]);
    ctx.strokeStyle = '#fc6';
    ctx.lineWidth = 2;
    state.trade_routes.forEach(tr => {
      const fp = state.provinces[tr.from], tp = state.provinces[tr.to];
      if (!fp || !tp) return;
      ctx.beginPath();
      ctx.moveTo(sx(fp.x), sy(fp.y));
      ctx.lineTo(sx(tp.x), sy(tp.y));
      ctx.stroke();
    });
    ctx.setLineDash([]);
  }

  // Draw provinces
  provs.forEach(([pid, prov]) => {
    const x = sx(prov.x), y = sy(prov.y);
    const ownerIdx = playerIds.indexOf(prov.owner);
    const ownerColor = prov.owner ? COLORS[ownerIdx] || '#444' : '#333';
    const terrainColor = TERRAIN_COLORS[prov.terrain] || '#333';
    const r = 22 + Math.min(prov.unit_count || 0, 10) * 1.5;

    // Territory glow
    if (prov.owner) {
      ctx.beginPath();
      ctx.arc(x, y, r + 8, 0, Math.PI * 2);
      ctx.fillStyle = ownerColor + '20';
      ctx.fill();
    }

    // Terrain circle
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fillStyle = terrainColor;
    ctx.fill();
    ctx.strokeStyle = ownerColor;
    ctx.lineWidth = prov.owner ? 3 : 1;
    ctx.stroke();

    // Battle flash
    if (battleFlash[pid] > 0) {
      ctx.beginPath();
      ctx.arc(x, y, r + 4 + battleFlash[pid], 0, Math.PI * 2);
      ctx.strokeStyle = `rgba(255,100,50,${battleFlash[pid]/20})`;
      ctx.lineWidth = 3;
      ctx.stroke();
      battleFlash[pid]--;
    }

    // Province name
    ctx.fillStyle = '#fff';
    ctx.font = '10px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(prov.name || pid, x, y - r - 4);

    // Defense indicator
    if (prov.defense > 0) {
      ctx.fillStyle = '#aaa';
      ctx.font = '8px system-ui';
      ctx.fillText('ğŸ›¡' + prov.defense, x + r + 2, y - 6);
    }

    // Buildings
    const bldgs = prov.buildings || [];
    if (bldgs.length > 0) {
      ctx.font = '9px system-ui';
      const bstr = bldgs.map(b => BLDG_EMOJI[b] || b).join('');
      ctx.fillStyle = '#ddd';
      ctx.fillText(bstr, x, y - 5);
    }

    // Units
    if (prov.units && prov.unit_count > 0) {
      let yoff = 6;
      Object.entries(prov.units).forEach(([uowner, counts]) => {
        const ci = playerIds.indexOf(uowner);
        let parts = [];
        counts.forEach((c, i) => { if (c > 0) parts.push(UNIT_EMOJI[i] + c); });
        if (parts.length > 0) {
          ctx.fillStyle = COLORS[ci] || '#fff';
          ctx.font = '9px system-ui';
          ctx.fillText(parts.join(' '), x, y + yoff);
          yoff += 11;
        }
      });
    }

    // Strength
    if (prov.strength > 0) {
      ctx.fillStyle = '#ff8';
      ctx.font = 'bold 11px system-ui';
      ctx.fillText(prov.strength, x, y + r + 12);
    }
  });
}

// â”€â”€ Tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onMouse(e) {
  if (!replay) return;
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  const W = rect.width, H = rect.height;
  const pad = 40;

  const t = replay.turns[turnIdx];
  if (!t) return;
  const state = t.state;

  let found = null;
  for (const [pid, prov] of Object.entries(state.provinces)) {
    const x = pad + (prov.x / 1000) * (W - pad*2);
    const y = pad + (prov.y / 1000) * (H - pad*2);
    const r = 22 + Math.min(prov.unit_count || 0, 10) * 1.5;
    if (Math.hypot(mx-x, my-y) < r + 5) { found = { pid, prov, sx: e.clientX, sy: e.clientY }; break; }
  }

  const tip = document.getElementById('tooltip');
  if (!found) { tip.style.display = 'none'; return; }

  const p = found.prov;
  const terrain = TERRAIN_NAMES[p.terrain] || p.terrain;
  const bldgs = (p.buildings||[]).map(b => BLDG_NAMES[b]||b).join(', ') || 'none';
  let unitLines = [];
  if (p.units) {
    for (const [owner, counts] of Object.entries(p.units)) {
      let parts = [];
      counts.forEach((c,i) => { if (c>0) parts.push(`${UNIT_NAMES[i]}:${c}`); });
      if (parts.length) unitLines.push(`${owner}: ${parts.join(', ')}`);
    }
  }

  const incomeStr = p.income ? `ğŸ–${p.income[0]} â›ï¸${p.income[1]} ğŸ’°${p.income[2]}` : 'â€”';
  tip.innerHTML = `<b>${p.name || found.pid}</b><br>
    Terrain: ${terrain} | Defense: ${p.defense||0}<br>
    Owner: ${p.owner || 'neutral'}<br>
    Income: ${incomeStr}<br>
    Buildings: ${bldgs}<br>
    ${unitLines.length ? 'Units:<br>' + unitLines.join('<br>') : 'No units'}
    ${p.strength ? '<br>Total Strength: ' + p.strength : ''}`;
  tip.style.display = 'block';
  tip.style.left = Math.min(found.sx + 10, window.innerWidth - 260) + 'px';
  tip.style.top = (found.sy + 10) + 'px';
}

// â”€â”€ Animation loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animLoop() {
  let any = false;
  for (const k in battleFlash) { if (battleFlash[k] > 0) any = true; }
  if (any && replay) render();
  requestAnimationFrame(animLoop);
}
animLoop();
</script>
</body>
</html>
